!-------------------------------------------------------------------------------
! (c) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-------------------------------------------------------------------------------
!> @brief Code to calculate and output the freezing level

module freeze_lev_alg_mod

  use field_mod,                   only: field_type
  use io_config_mod,               only: use_xios_io
  use initialise_diagnostics_mod,  only: init_diag => init_diagnostic_field
  use mr_indices_mod,              only: nummr, imr_v
  use moist_dyn_mod,               only: num_moist_factors, total_mass
  use sci_geometric_constants_mod, only: get_height
  use fs_continuity_mod,           only: Wtheta

  implicit none
  private

  public :: freeze_lev_alg

contains

  !> @details Output diagnostic of wet-bulb freezing level
  !> @param[in]  theta       potential temperature
  !> @param[in]  mr          Mixing ratios
  !> @param[in]  moist_dyn   Moist dynamics factors
  !> @param[in]  exner_wth   exner pressure in wth space
  subroutine freeze_lev_alg(theta, mr, moist_dyn, exner_wth)

    use freeze_lev_kernel_mod, only: freeze_lev_kernel_type

    implicit none

    ! Arguments

    type( field_type ), intent(in) :: theta
    type( field_type ), intent(in) :: exner_wth
    type( field_type ), intent(in) :: mr(nummr)
    type( field_type ), intent(in) :: moist_dyn(num_moist_factors)

    ! Local fields
    type( field_type ) :: freeze_lev
    type( field_type), pointer :: height_wth

    if (init_diag(freeze_lev, 'processed__freeze_lev') .and. use_xios_io) then

      height_wth => get_height(Wtheta, theta%get_mesh_id())

      call invoke( freeze_lev_kernel_type(theta, mr(imr_v),                  &
                                          moist_dyn(total_mass), exner_wth,  &
                                          height_wth, freeze_lev) )
      call freeze_lev%write_field()

    end if

  end subroutine freeze_lev_alg

end module freeze_lev_alg_mod
