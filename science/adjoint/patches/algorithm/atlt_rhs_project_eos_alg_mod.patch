@@ -1,22 +1,25 @@
-module adjoint_test_mod
+module atlt_rhs_project_eos_alg_mod
   implicit none
   public
 
   contains
-  subroutine adjoint_test(mesh, chi, panel_id)
+  subroutine atlt_rhs_project_eos_alg(mesh, chi, panel_id)
+    use assign_field_random_range_alg_mod, only : assign_field_random_range
     use field_mod, only : field_type
     use function_space_mod, only : function_space_type
     use mesh_mod, only : mesh_type
     use function_space_collection_mod, only : function_space_collection
     use tl_rhs_project_eos_kernel_mod, only : tl_rhs_project_eos_kernel_type
-    use adj_rhs_project_eos_kernel_mod, only : adj_rhs_project_eos_kernel_type
+    use atl_rhs_project_eos_kernel_mod, only : atl_rhs_project_eos_kernel_type
     use finite_element_config_mod, only : element_order
     use fs_continuity_mod, only : w0, w3, wtheta
     use constants_mod, only : i_def, r_def
+    use planet_config_mod, only : kappa, rd, p_zero
     use quadrature_xyoz_mod, only : quadrature_xyoz_type
     use quadrature_rule_gaussian_mod, only : quadrature_rule_gaussian_type
     use setop_random_kernel_mod, only : setop_random_kernel_type
     use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space
+    use adjoint_test_parameters_mod, only : ls_exner_range, ls_rho_range, ls_theta_range, ls_md1_range
     real(kind=r_def), parameter :: overall_tolerance = 1500.0_r_def
     type(mesh_type), pointer, intent(in) :: mesh
     type(field_type), dimension(3), intent(in), optional :: chi
@@ -33,50 +36,25 @@
     type(field_type) :: ls_rho
     type(field_type) :: ls_theta
     type(field_type) :: ls_moist_dyn_gas
-    type(field_type), dimension(3) :: chi3
-    type(field_type) :: panel_id_1
-    real(kind=r_def) :: kappa
-    real(kind=r_def) :: rd
-    real(kind=r_def) :: p_zero
     type(quadrature_xyoz_type) :: qr_xyoz
     type(quadrature_rule_gaussian_type) :: quadrature_rule
-    real(kind=r_def) :: kappa_input
-    real(kind=r_def) :: rd_input
-    real(kind=r_def) :: p_zero_input
     type(field_type) :: rhs_eos_input
     type(field_type) :: exner_input
     type(field_type) :: rho_input
     type(field_type) :: theta_input
     type(field_type) :: moist_dyn_gas_input
-    type(field_type) :: ls_exner_input
-    type(field_type) :: ls_rho_input
-    type(field_type) :: ls_theta_input
-    type(field_type) :: ls_moist_dyn_gas_input
-    type(field_type), dimension(3) :: chi3_input
-    type(field_type) :: panel_id_1_input
     real(kind=r_def) :: rhs_eos_inner_prod
     real(kind=r_def) :: exner_inner_prod
     real(kind=r_def) :: rho_inner_prod
     real(kind=r_def) :: theta_inner_prod
     real(kind=r_def) :: moist_dyn_gas_inner_prod
-    real(kind=r_def) :: ls_exner_inner_prod
-    real(kind=r_def) :: ls_rho_inner_prod
-    real(kind=r_def) :: ls_theta_inner_prod
-    real(kind=r_def) :: ls_moist_dyn_gas_inner_prod
-    real(kind=r_def), dimension(3) :: chi3_inner_prod
-    real(kind=r_def) :: panel_id_1_inner_prod
     real(kind=r_def) :: inner1
     real(kind=r_def) :: rhs_eos_rhs_eos_input_inner_prod
     real(kind=r_def) :: exner_exner_input_inner_prod
     real(kind=r_def) :: rho_rho_input_inner_prod
     real(kind=r_def) :: theta_theta_input_inner_prod
     real(kind=r_def) :: moist_dyn_gas_moist_dyn_gas_input_inner_prod
-    real(kind=r_def) :: ls_exner_ls_exner_input_inner_prod
-    real(kind=r_def) :: ls_rho_ls_rho_input_inner_prod
-    real(kind=r_def) :: ls_theta_ls_theta_input_inner_prod
-    real(kind=r_def) :: ls_moist_dyn_gas_ls_moist_dyn_gas_input_inner_prod
-    real(kind=r_def), dimension(3) :: chi3_chi3_input_inner_prod
-    real(kind=r_def) :: panel_id_1_panel_id_1_input_inner_prod
+    real(kind=r_def), parameter :: rhs_eos_sf = 1.0E-32_r_def
     real(kind=r_def) :: inner2
     real(kind=r_def) :: MachineTol
     real(kind=r_def) :: relative_diff
@@ -93,118 +71,58 @@
     call ls_rho % initialise(vector_space=vector_space_w3_ptr, name='ls_rho')
     call ls_theta % initialise(vector_space=vector_space_wtheta_ptr, name='ls_theta')
     call ls_moist_dyn_gas % initialise(vector_space=vector_space_wtheta_ptr, name='ls_moist_dyn_gas')
-    call chi3(1_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call chi3(2_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call chi3(3_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call panel_id_1 % initialise(vector_space=vector_space_w3_ptr, name='panel_id_1')
     qr_xyoz = quadrature_xyoz_type(element_order + 3,quadrature_rule)
     call rhs_eos_input % initialise(vector_space=vector_space_w3_ptr, name='rhs_eos_input')
     call exner_input % initialise(vector_space=vector_space_w3_ptr, name='exner_input')
     call rho_input % initialise(vector_space=vector_space_w3_ptr, name='rho_input')
     call theta_input % initialise(vector_space=vector_space_wtheta_ptr, name='theta_input')
     call moist_dyn_gas_input % initialise(vector_space=vector_space_wtheta_ptr, name='moist_dyn_gas_input')
-    call ls_exner_input % initialise(vector_space=vector_space_w3_ptr, name='ls_exner_input')
-    call ls_rho_input % initialise(vector_space=vector_space_w3_ptr, name='ls_rho_input')
-    call ls_theta_input % initialise(vector_space=vector_space_wtheta_ptr, name='ls_theta_input')
-    call ls_moist_dyn_gas_input % initialise(vector_space=vector_space_wtheta_ptr, name='ls_moist_dyn_gas_input')
-    call chi3_input(1_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call chi3_input(2_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call chi3_input(3_i_def) % initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call panel_id_1_input % initialise(vector_space=vector_space_w3_ptr, name='panel_id_1_input')
-    call RANDOM_NUMBER(kappa)
-    kappa_input = kappa
-    call RANDOM_NUMBER(rd)
-    rd_input = rd
-    call RANDOM_NUMBER(p_zero)
-    p_zero_input = p_zero
     rhs_eos_inner_prod = 0.0_r_def
     exner_inner_prod = 0.0_r_def
     rho_inner_prod = 0.0_r_def
     theta_inner_prod = 0.0_r_def
     moist_dyn_gas_inner_prod = 0.0_r_def
-    ls_exner_inner_prod = 0.0_r_def
-    ls_rho_inner_prod = 0.0_r_def
-    ls_theta_inner_prod = 0.0_r_def
-    ls_moist_dyn_gas_inner_prod = 0.0_r_def
-    chi3_inner_prod(1_i_def) = 0.0_r_def
-    chi3_inner_prod(2_i_def) = 0.0_r_def
-    chi3_inner_prod(3_i_def) = 0.0_r_def
-    panel_id_1_inner_prod = 0.0_r_def
     ! Initialise arguments and call the tangent-linear kernel.
     call invoke(setval_random(rhs_eos), setval_x(rhs_eos_input, rhs_eos), setval_random(exner), setval_x(exner_input, exner), &
 &setval_random(rho), setval_x(rho_input, rho), setval_random(theta), setval_x(theta_input, theta), setval_random(moist_dyn_gas), &
-&setval_x(moist_dyn_gas_input, moist_dyn_gas), setval_random(ls_exner), setval_x(ls_exner_input, ls_exner), setval_random(ls_rho), &
-&setval_x(ls_rho_input, ls_rho), setval_random(ls_theta), setval_x(ls_theta_input, ls_theta), setval_random(ls_moist_dyn_gas), &
-&setval_x(ls_moist_dyn_gas_input, ls_moist_dyn_gas), setval_random(chi3(1_i_def)), setval_x(chi3_input(1_i_def), chi3(1_i_def)), &
-&setval_random(chi3(2_i_def)), setval_x(chi3_input(2_i_def), chi3(2_i_def)), setval_random(chi3(3_i_def)), &
-&setval_x(chi3_input(3_i_def), chi3(3_i_def)), setval_random(panel_id_1), setval_x(panel_id_1_input, panel_id_1), &
-&tl_rhs_project_eos_kernel_type(rhs_eos, exner, rho, theta, moist_dyn_gas, ls_exner, ls_rho, ls_theta, ls_moist_dyn_gas, chi3, &
-&panel_id_1, kappa, rd, p_zero, qr_xyoz), x_innerproduct_x(rhs_eos_inner_prod, rhs_eos), x_innerproduct_x(exner_inner_prod, &
+&setval_x(moist_dyn_gas_input, moist_dyn_gas))
+
+    call assign_field_random_range( ls_exner, ls_exner_range(1), ls_exner_range(2) )
+    call assign_field_random_range( ls_rho, ls_rho_range(1), ls_rho_range(2) )
+    call assign_field_random_range( ls_theta, ls_theta_range(1), ls_theta_range(2) )
+    call assign_field_random_range( ls_moist_dyn_gas, ls_md1_range(1), ls_md1_range(2) )
+
+    call invoke(tl_rhs_project_eos_kernel_type(rhs_eos, exner, rho, theta, moist_dyn_gas, ls_exner, ls_rho, ls_theta, &
+&ls_moist_dyn_gas, chi, panel_id, kappa, rd, p_zero, qr_xyoz), &
+&x_innerproduct_x(rhs_eos_inner_prod, rhs_eos), x_innerproduct_x(exner_inner_prod, &
 &exner), x_innerproduct_x(rho_inner_prod, rho), x_innerproduct_x(theta_inner_prod, theta), &
-&x_innerproduct_x(moist_dyn_gas_inner_prod, moist_dyn_gas), x_innerproduct_x(ls_exner_inner_prod, ls_exner), &
-&x_innerproduct_x(ls_rho_inner_prod, ls_rho), x_innerproduct_x(ls_theta_inner_prod, ls_theta), &
-&x_innerproduct_x(ls_moist_dyn_gas_inner_prod, ls_moist_dyn_gas), x_innerproduct_x(chi3_inner_prod(1_i_def), chi3(1_i_def)), &
-&x_innerproduct_x(chi3_inner_prod(2_i_def), chi3(2_i_def)), x_innerproduct_x(chi3_inner_prod(3_i_def), chi3(3_i_def)), &
-&x_innerproduct_x(panel_id_1_inner_prod, panel_id_1))
+&x_innerproduct_x(moist_dyn_gas_inner_prod, moist_dyn_gas))
+
     inner1 = 0.0_r_def
-    inner1 = inner1 + kappa * kappa
-    inner1 = inner1 + rd * rd
-    inner1 = inner1 + p_zero * p_zero
-    inner1 = inner1 + rhs_eos_inner_prod
+    inner1 = inner1 + rhs_eos_inner_prod*rhs_eos_sf
     inner1 = inner1 + exner_inner_prod
     inner1 = inner1 + rho_inner_prod
     inner1 = inner1 + theta_inner_prod
     inner1 = inner1 + moist_dyn_gas_inner_prod
-    inner1 = inner1 + ls_exner_inner_prod
-    inner1 = inner1 + ls_rho_inner_prod
-    inner1 = inner1 + ls_theta_inner_prod
-    inner1 = inner1 + ls_moist_dyn_gas_inner_prod
-    inner1 = inner1 + chi3_inner_prod(1_i_def)
-    inner1 = inner1 + chi3_inner_prod(2_i_def)
-    inner1 = inner1 + chi3_inner_prod(3_i_def)
-    inner1 = inner1 + panel_id_1_inner_prod
+
+    call invoke( inc_a_times_X( rhs_eos_sf, rhs_eos ) )
+
     rhs_eos_rhs_eos_input_inner_prod = 0.0_r_def
     exner_exner_input_inner_prod = 0.0_r_def
     rho_rho_input_inner_prod = 0.0_r_def
     theta_theta_input_inner_prod = 0.0_r_def
     moist_dyn_gas_moist_dyn_gas_input_inner_prod = 0.0_r_def
-    ls_exner_ls_exner_input_inner_prod = 0.0_r_def
-    ls_rho_ls_rho_input_inner_prod = 0.0_r_def
-    ls_theta_ls_theta_input_inner_prod = 0.0_r_def
-    ls_moist_dyn_gas_ls_moist_dyn_gas_input_inner_prod = 0.0_r_def
-    chi3_chi3_input_inner_prod(1_i_def) = 0.0_r_def
-    chi3_chi3_input_inner_prod(2_i_def) = 0.0_r_def
-    chi3_chi3_input_inner_prod(3_i_def) = 0.0_r_def
-    panel_id_1_panel_id_1_input_inner_prod = 0.0_r_def
-    call invoke(adj_rhs_project_eos_kernel_type(rhs_eos, exner, rho, theta, moist_dyn_gas, ls_exner, ls_rho, ls_theta, &
-&ls_moist_dyn_gas, chi3, panel_id_1, kappa, rd, p_zero, qr_xyoz), x_innerproduct_y(rhs_eos_rhs_eos_input_inner_prod, rhs_eos, &
+    call invoke(atl_rhs_project_eos_kernel_type(rhs_eos, exner, rho, theta, moist_dyn_gas, ls_exner, ls_rho, ls_theta, &
+&ls_moist_dyn_gas, chi, panel_id, kappa, rd, p_zero, qr_xyoz), x_innerproduct_y(rhs_eos_rhs_eos_input_inner_prod, rhs_eos, &
 &rhs_eos_input), x_innerproduct_y(exner_exner_input_inner_prod, exner, exner_input), x_innerproduct_y(rho_rho_input_inner_prod, &
 &rho, rho_input), x_innerproduct_y(theta_theta_input_inner_prod, theta, theta_input), &
-&x_innerproduct_y(moist_dyn_gas_moist_dyn_gas_input_inner_prod, moist_dyn_gas, moist_dyn_gas_input), &
-&x_innerproduct_y(ls_exner_ls_exner_input_inner_prod, ls_exner, ls_exner_input), x_innerproduct_y(ls_rho_ls_rho_input_inner_prod, &
-&ls_rho, ls_rho_input), x_innerproduct_y(ls_theta_ls_theta_input_inner_prod, ls_theta, ls_theta_input), &
-&x_innerproduct_y(ls_moist_dyn_gas_ls_moist_dyn_gas_input_inner_prod, ls_moist_dyn_gas, ls_moist_dyn_gas_input), &
-&x_innerproduct_y(chi3_chi3_input_inner_prod(1_i_def), chi3(1_i_def), chi3_input(1_i_def)), &
-&x_innerproduct_y(chi3_chi3_input_inner_prod(2_i_def), chi3(2_i_def), chi3_input(2_i_def)), &
-&x_innerproduct_y(chi3_chi3_input_inner_prod(3_i_def), chi3(3_i_def), chi3_input(3_i_def)), &
-&x_innerproduct_y(panel_id_1_panel_id_1_input_inner_prod, panel_id_1, panel_id_1_input))
+&x_innerproduct_y(moist_dyn_gas_moist_dyn_gas_input_inner_prod, moist_dyn_gas, moist_dyn_gas_input))
     inner2 = 0.0_r_def
-    inner2 = inner2 + kappa * kappa_input
-    inner2 = inner2 + rd * rd_input
-    inner2 = inner2 + p_zero * p_zero_input
     inner2 = inner2 + rhs_eos_rhs_eos_input_inner_prod
     inner2 = inner2 + exner_exner_input_inner_prod
     inner2 = inner2 + rho_rho_input_inner_prod
     inner2 = inner2 + theta_theta_input_inner_prod
     inner2 = inner2 + moist_dyn_gas_moist_dyn_gas_input_inner_prod
-    inner2 = inner2 + ls_exner_ls_exner_input_inner_prod
-    inner2 = inner2 + ls_rho_ls_rho_input_inner_prod
-    inner2 = inner2 + ls_theta_ls_theta_input_inner_prod
-    inner2 = inner2 + ls_moist_dyn_gas_ls_moist_dyn_gas_input_inner_prod
-    inner2 = inner2 + chi3_chi3_input_inner_prod(1_i_def)
-    inner2 = inner2 + chi3_chi3_input_inner_prod(2_i_def)
-    inner2 = inner2 + chi3_chi3_input_inner_prod(3_i_def)
-    inner2 = inner2 + panel_id_1_panel_id_1_input_inner_prod
     ! Test the inner-product values for equality, allowing for the precision of the active variables
     MachineTol = SPACING(MAX(ABS(inner1), ABS(inner2)))
     relative_diff = ABS(inner1 - inner2) / MachineTol
@@ -216,6 +134,6 @@
       call log_event(log_scratch_space, log_level_error)
     end if
 
-  end subroutine adjoint_test
+  end subroutine atlt_rhs_project_eos_alg
 
-end module adjoint_test_mod
+end module atlt_rhs_project_eos_alg_mod
