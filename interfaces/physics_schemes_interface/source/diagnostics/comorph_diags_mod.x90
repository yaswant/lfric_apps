!-------------------------------------------------------------------------------
! (c) Crown copyright 2024 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-------------------------------------------------------------------------------
!> @brief Processes diagnostics for comorph_alg

module comorph_diags_mod

  use constants_mod,       only: l_def
  use field_mod,           only: field_type
  use timing_mod,          only: start_timing, stop_timing, tik, LPROF
  use initialise_diagnostics_mod,     only : init_diag &
                                             => init_diagnostic_field

  implicit none

  private

  ! Logical indicating whether diagnostics are requested
  logical( l_def ) :: lowest_cv_base_flag,         &
                      lowest_cv_top_flag,          &
                      pres_cv_base_flag,           &
                      pres_cv_top_flag,            &
                      pres_lowest_cv_base_flag,    &
                      pres_lowest_cv_top_flag,     &
                      lowest_cca_2d_flag,          &
                      entrain_up_flag,             & ! 3-D
                      entrain_down_flag,           &
                      detrain_up_flag,             &
                      detrain_down_flag,           &
                      massflux_up_half_flag

  public :: initialise_diags_for_comorph
  public :: output_diags_for_comorph

contains

  !> @brief Initialise fields for locally-computed diagnostics
  subroutine initialise_diags_for_comorph(lowest_cv_base,         &
                                          lowest_cv_top,          &
                                          cv_base,                &
                                          cv_top,                 &
                                          pres_cv_base,           &
                                          pres_cv_top,            &
                                          pres_lowest_cv_base,    &
                                          pres_lowest_cv_top,     &
                                          lowest_cca_2d,          &
                                          entrain_up,             & ! 3-D
                                          entrain_down,           &
                                          detrain_up,             &
                                          detrain_down,           &
                                          massflux_up_half)

    implicit none

    ! Diagnostic fields to initialise
    type( field_type ), intent(inout) :: lowest_cv_base,          &
                                         lowest_cv_top,           &
                                         cv_base,                 &
                                         cv_top,                  &
                                         pres_cv_base,            &
                                         pres_cv_top,             &
                                         pres_lowest_cv_base,     &
                                         pres_lowest_cv_top,      &
                                         lowest_cca_2d,           &
                                         entrain_up,              & ! 3-D
                                         entrain_down,            &
                                         detrain_up,              &
                                         detrain_down,            &
                                         massflux_up_half
    integer(tik)  :: id

    if ( LPROF ) call start_timing( id, 'diags.comorph' )

    ! Convective diagnostics - 2d
    lowest_cv_base_flag = init_diag(lowest_cv_base, 'convection__lowest_cv_base')
    lowest_cv_top_flag = init_diag(lowest_cv_top, 'convection__lowest_cv_top')

    ! cv_base and _top are dependencies for chemistry, hence need to be 'active'

    pres_cv_base_flag = init_diag(pres_cv_base, 'convection__pres_cv_base')
    pres_cv_top_flag = init_diag(pres_cv_top, 'convection__pres_cv_top')

    pres_lowest_cv_base_flag = init_diag(pres_lowest_cv_base, &
                                         'convection__pres_lowest_cv_base')
    pres_lowest_cv_top_flag = init_diag(pres_lowest_cv_top, &
                                        'convection__pres_lowest_cv_top')

    lowest_cca_2d_flag = init_diag(lowest_cca_2d, &
                                   'convection__lowest_cca_2d')

    ! Convective diagnostics - 3d  - theta levels
    entrain_up_flag = init_diag(entrain_up, 'convection__entrain_up')
    if (entrain_up_flag) call invoke( setval_c(entrain_up, 0.0_r_def) )

    entrain_down_flag = init_diag(entrain_down, 'convection__entrain_down')
    if (entrain_down_flag) call invoke( setval_c(entrain_down, 0.0_r_def) )

    detrain_up_flag = init_diag(detrain_up, 'convection__detrain_up')
    if (detrain_up_flag) call invoke( setval_c(detrain_up, 0.0_r_def) )

    detrain_down_flag = init_diag(detrain_down, 'convection__detrain_down')
    if (detrain_down_flag) call invoke( setval_c(detrain_down, 0.0_r_def) )

    massflux_up_half_flag = init_diag(massflux_up_half, 'convection__massflux_up_half')

    if ( LPROF ) call stop_timing( id, 'diags.comorph' )

  end subroutine initialise_diags_for_comorph

  !> @brief Output diagnostics from comorph_alg
  subroutine output_diags_for_comorph( cca,                 & ! prognostics
                                    ccw,                    &
                                    dt_conv,                & ! increments
                                    dmv_conv,               &
                                    dmcl_conv,              &
                                    dms_conv,               &
                                    du_conv,                &
                                    dv_conv,                &
                                    dbcf_conv,              &
                                    dcfl_conv,              &
                                    dcff_conv,              &
                                    massflux_up,            & ! not local
                                    massflux_down,          &
                                    cape_diluted,           &
                                    conv_rain,              &
                                    conv_snow,              &
                                    conv_rain_3d,           &
                                    conv_snow_3d,           &
                                    cca_2d,                 &
                                    lowest_cv_base,         &
                                    lowest_cv_top,          &
                                    cv_base,                &
                                    cv_top,                 &
                                    pres_cv_base,           &
                                    pres_cv_top,            &
                                    pres_lowest_cv_base,    &
                                    pres_lowest_cv_top,     &
                                    lowest_cca_2d,          &
                                    entrain_up,             & ! 3-D
                                    entrain_down,           &
                                    detrain_up,             &
                                    detrain_down,           &
                                    massflux_up_half)

    implicit none

    ! Prognostic fields to output
    type( field_type ), intent(in)  :: cca, &
                                       ccw
    ! Increment fields to output
    type( field_type ), intent(in)  :: dt_conv,   &
                                       dmv_conv,  &
                                       dmcl_conv, &
                                       dms_conv,  &
                                       du_conv,   &
                                       dv_conv,   &
                                       dbcf_conv, &
                                       dcfl_conv, &
                                       dcff_conv
    ! higher-level fields to output
    type( field_type ), intent(in)  :: massflux_up,   &
                                       massflux_down, &
                                       cape_diluted,  &
                                       conv_rain,     &
                                       conv_snow,     &
                                       conv_rain_3d,  &
                                       conv_snow_3d,  &
                                       cca_2d
    ! local diagnostic fields to output
    type( field_type ), intent(in)  :: lowest_cv_base,         &
                                       lowest_cv_top,          &
                                       cv_base,                &
                                       cv_top,                 &
                                       pres_cv_base,           &
                                       pres_cv_top,            &
                                       pres_lowest_cv_base,    &
                                       pres_lowest_cv_top,     &
                                       lowest_cca_2d,          &
                                       entrain_up,             & ! 3-D
                                       entrain_down,           &
                                       detrain_up,             &
                                       detrain_down,           &
                                       massflux_up_half
    integer(tik)  :: id

    if ( LPROF ) call start_timing( id, 'diags.comorph' )

    ! Prognostic fields
    call cca%write_field('convection__cca')
    call ccw%write_field('convection__ccw')

    ! Increments
    call dt_conv%write_field('convection__dt_conv')
    call dmv_conv%write_field('convection__dmv_conv')
    call dmcl_conv%write_field('convection__dmcl_conv')
    call dms_conv%write_field('convection__dms_conv')
    call du_conv%write_field('convection__du_conv')
    call dv_conv%write_field('convection__dv_conv')
    call dbcf_conv%write_field('convection__dbcf_conv')
    call dcfl_conv%write_field('convection__dcfl_conv')
    call dcff_conv%write_field('convection__dcff_conv')

    ! not local
    call massflux_up%write_field('convection__massflux_up')
    call massflux_down%write_field('convection__massflux_down')
    call cape_diluted%write_field('convection__cape_diluted')
    call conv_rain%write_field('convection__conv_rain')
    call conv_snow%write_field('convection__conv_snow')
    call conv_rain_3d%write_field('convection__conv_rain_3d')
    call conv_snow_3d%write_field('convection__conv_snow_3d')
    call cca_2d%write_field('convection__cca_2d')

    ! Diagnostics computed within the kernel
    ! 2D
    if (lowest_cv_base_flag) call lowest_cv_base%write_field()
    if (lowest_cv_top_flag) call lowest_cv_top%write_field()
    call cv_base%write_field()
    call cv_top%write_field()
    if (pres_cv_base_flag) call pres_cv_base%write_field()
    if (pres_cv_top_flag) call pres_cv_top%write_field()
    if (pres_lowest_cv_base_flag) call pres_lowest_cv_base%write_field()
    if (pres_lowest_cv_top_flag) call pres_lowest_cv_top%write_field()
    if (lowest_cca_2d_flag) call lowest_cca_2d%write_field()

    ! 3D
    if (entrain_up_flag) call entrain_up%write_field()
    if (entrain_down_flag) call entrain_down%write_field()
    if (detrain_up_flag) call detrain_up%write_field()
    if (detrain_down_flag) call detrain_down%write_field()
    if (massflux_up_half_flag) call massflux_up_half%write_field()

    if ( LPROF ) call stop_timing( id, 'diags.comorph' )

  end subroutine output_diags_for_comorph
end module comorph_diags_mod
