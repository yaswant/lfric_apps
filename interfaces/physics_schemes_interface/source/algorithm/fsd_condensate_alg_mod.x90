!-------------------------------------------------------------------------------
! (c) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-------------------------------------------------------------------------------

!> @brief Interface to calculate fractional standard deviation of condensate

module fsd_condensate_alg_mod

  use constants_mod,        only: i_def
  use field_mod,            only: field_type
  use field_collection_mod, only: field_collection_type
  use mesh_mod,             only: mesh_type
  use sci_geometric_constants_mod, only: get_delta_at_wtheta, get_dz_at_wtheta

   implicit none

   private

   public fsd_condensate_alg

contains
  !>@brief   Calculate fractional standard deviation (FSD) condensate
  !>@details Uses cloud fraction, grid box size and convective cloudiness
  !>         to determine variability in condensate for use by
  !>         radiation and microphysics scheme.
  !>         See Hill et al (2015, DOI: 10.1002/qj.2506) for full details.
  !>@param[in,out] f_arr             Array of params for FSD
  !>@param[in,out] cloud_fields      Group of cloud fields
  !>@param[in]     convection_fields Group of convection fields

  subroutine fsd_condensate_alg( f_arr, cloud_fields, convection_fields )

    use fsd_condensate_kernel_mod, only: fsd_condensate_kernel_type
    use timing_mod,                only: start_timing, stop_timing, tik, LPROF

    implicit none

    type( field_type ),            intent(inout) :: f_arr
    type( field_collection_type ), intent(in)    :: cloud_fields
    type( field_collection_type ), intent(in)    :: convection_fields

    type( field_type ), pointer :: dz_wth
    type( field_type ), pointer :: delta

    type( field_type ), pointer :: area_fraction
    type( field_type ), pointer :: frozen_fraction
    type( field_type ), pointer :: sigma_ml
    type( field_type ), pointer :: sigma_mi
    type( field_type ), pointer :: cca

    type( mesh_type), pointer   :: mesh
    integer(tik)                :: id

    if ( LPROF ) call start_timing( id, 'cloud.fsd_condensate' )

    ! Unpack fields
    call cloud_fields%get_field('area_fraction', area_fraction)
    call cloud_fields%get_field('frozen_fraction', frozen_fraction)
    call cloud_fields%get_field('sigma_ml', sigma_ml)
    call cloud_fields%get_field('sigma_mi', sigma_mi)
    call convection_fields%get_field('cca', cca)

    mesh => area_fraction%get_mesh()

    delta  => get_delta_at_wtheta(mesh%get_id())
    dz_wth => get_dz_at_wtheta(mesh%get_id())

    call invoke ( fsd_condensate_kernel_type ( sigma_ml,        & ! fsd of condensate
                                               f_arr,           & ! fsd parameters
                                               area_fraction,   & ! area cloud fraction
                                               frozen_fraction, &
                                               cca,             & ! convective cloud amount
                                               dz_wth,          & ! dz at wtheta
                                               delta ),         & ! edge length
                  ! Set ice FSD equal to liquid FSD
                  setval_X(sigma_mi, sigma_ml) )

    nullify( mesh )

    if ( LPROF ) call stop_timing( id, 'cloud.fsd_condensate' )

  end subroutine fsd_condensate_alg

end module fsd_condensate_alg_mod
