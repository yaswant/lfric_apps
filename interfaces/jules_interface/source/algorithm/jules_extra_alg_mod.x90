!-------------------------------------------------------------------------------
! (c) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-------------------------------------------------------------------------------
!> @brief Interface to the JULES surf_couple_extra scheme

module jules_extra_alg_mod

  use constants_mod,                 only: i_def, r_def
  use field_mod,                     only: field_type
  use integer_field_mod,             only: integer_field_type
  use field_collection_mod,          only: field_collection_type
  use mesh_mod,                      only: mesh_type

  use timing_mod,         only: start_timing, stop_timing, &
                                tik, LPROF
  use surface_config_mod, only: lake_water_conservation

  ! xios output
  use io_config_mod, only: write_diag, use_xios_io
  use jules_snow_diags_mod, only: initialise_diags_for_jules_snow, &
                                  output_diags_for_jules_snow
  use jules_soil_diags_mod, only: initialise_diags_for_jules_soil, &
                                  output_diags_for_jules_soil
  use jules_seaice_diags_mod, only: output_diags_for_jules_seaice

  ! Other algorithms
  use lake_water_correction_alg_mod, only: lake_water_correction

  implicit none

  private
  public jules_extra_alg

contains

  !> @brief Run the JULES surf_couple_extra scheme
  !> @details JULES surf_couple_extra calculates the surface and soil fluxes
  !> and stores of Water (via the hydrol{ogy}, snow and river_control
  !> modules) and Carbon (via triffid and inferno/fire modules). Note: only the
  !> hydrol and snow components are implemented so far.
  !>
  !> @param[in]     microphysics_fields Fields for mphys scheme
  !> @param[in]     convection_fields   Fields for convection scheme
  !> @param[in,out] surface_fields      Fields for surface scheme
  !> @param[in,out] soil_fields         Fields for soil hydrology scheme
  !> @param[in,out] snow_fields         Fields for snow scheme
  !> @param[in]     surf_heat_flux      Net surface heat flux (W m-2)
  !> @param[in]     canopy_evap         Canopy evaporation from land tiles (kg m-2 s-1)
  !> @param[in]     water_extraction    Extraction of water from each soil layer (kg m-2 s-1)
  !> @param[in]     lake_evap           Evaporation from lakes GBM
  !> @param[in]     dt                  Timestep length (s)
  subroutine jules_extra_alg(microphysics_fields, convection_fields,      &
                             surface_fields, soil_fields, snow_fields,    &
                             surf_heat_flux,                              &
                             canopy_evap, water_extraction, lake_evap, dt)

    use jules_extra_kernel_mod, only: jules_extra_kernel_type
    use um_sizes_init_mod,      only: um_sizes_init

    implicit none

    type( field_collection_type ), intent(in)    :: microphysics_fields
    type( field_collection_type ), intent(in)    :: convection_fields
    type( field_collection_type ), intent(inout) :: surface_fields
    type( field_collection_type ), intent(inout) :: soil_fields
    type( field_collection_type ), intent(inout) :: snow_fields

    type( field_type ), intent (in) :: surf_heat_flux
    type( field_type ), intent (in) :: canopy_evap
    type( field_type ), intent (in) :: water_extraction
    type( field_type ), intent (in) :: lake_evap
    real(r_def), intent(in) :: dt

    ! Temporary fields: unpacked fields from collections
    type( field_type ), pointer :: ls_rain                => null()
    type( field_type ), pointer :: ls_snow                => null()
    type( field_type ), pointer :: ls_graup               => null()
    type( field_type ), pointer :: conv_rain              => null()
    type( field_type ), pointer :: conv_snow              => null()
    type( field_type ), pointer :: lsca_2d                => null()
    type( field_type ), pointer :: cca_2d                 => null()

    type( field_type ), pointer :: tile_fraction          => null()
    type( field_type ), pointer :: leaf_area_index        => null()
    type( field_type ), pointer :: canopy_height          => null()
    type( field_type ), pointer :: tile_temperature       => null()
    type( field_type ), pointer :: net_prim_prod          => null()
    type( field_type ), pointer :: canopy_water           => null()
    type( field_type ), pointer :: snowice_melt           => null()
    type( field_type ), pointer :: snowice_sublimation    => null()
    type( field_type ), pointer :: urbztm                 => null()

    ! Sea ice fields
    type( field_type ), pointer :: sea_ice_thickness      => null()
    type( field_type ), pointer :: sea_ice_temperature    => null()
    type( field_type ), pointer :: sea_ice_conductivity   => null()
    type( field_type ), pointer :: sea_ice_pensolar       => null()
    type( field_type ), pointer :: melt_pond_fraction     => null()
    type( field_type ), pointer :: melt_pond_depth        => null()

    type( field_type ), pointer :: soil_moist_wilt        => null()
    type( field_type ), pointer :: soil_moist_crit        => null()
    type( field_type ), pointer :: soil_moist_sat         => null()
    type( field_type ), pointer :: soil_cond_sat          => null()
    type( field_type ), pointer :: soil_thermal_cap       => null()
    type( field_type ), pointer :: soil_thermal_cond      => null()
    type( field_type ), pointer :: soil_suction_sat       => null()
    type( field_type ), pointer :: clapp_horn_b           => null()
    type( field_type ), pointer :: soil_roughness         => null()
    type( field_type ), pointer :: mean_topog_index       => null()
    type( field_type ), pointer :: a_sat_frac             => null()
    type( field_type ), pointer :: c_sat_frac             => null()
    type( field_type ), pointer :: a_wet_frac             => null()
    type( field_type ), pointer :: c_wet_frac             => null()
    type( field_type ), pointer :: thermal_cond_wet_soil  => null()
    type( field_type ), pointer :: soil_temperature       => null()
    type( field_type ), pointer :: soil_moisture          => null()
    type( field_type ), pointer :: unfrozen_soil_moisture => null()
    type( field_type ), pointer :: frozen_soil_moisture   => null()
    type( field_type ), pointer :: soil_sat_frac          => null()
    type( field_type ), pointer :: water_table            => null()
    type( field_type ), pointer :: wetness_under_soil     => null()
    type( field_type ), pointer :: surface_runoff         => null()
    type( field_type ), pointer :: sub_surface_runoff     => null()

    type( field_type ), pointer :: tile_snow_mass         => null()
    type( field_type ), pointer :: tile_snow_rgrain       => null()
    type( integer_field_type ), pointer :: n_snow_layers  => null()
    type( field_type ), pointer :: snow_depth             => null()
    type( field_type ), pointer :: snow_under_canopy      => null()
    type( field_type ), pointer :: snowpack_density       => null()
    type( field_type ), pointer :: snow_layer_thickness   => null()
    type( field_type ), pointer :: snow_layer_ice_mass    => null()
    type( field_type ), pointer :: snow_layer_liq_mass    => null()
    type( field_type ), pointer :: snow_layer_temp        => null()
    type( field_type ), pointer :: snow_layer_rgrain      => null()
    type( field_type ), pointer :: snow_unload_rate       => null()

    ! local variables
    type( field_type ) :: soil_moisture_content
    type( field_type ) :: grid_canopy_water
    type( field_type ) :: grid_snow_mass
    type( field_type ) :: grid_snowmelt
    type( field_type ) :: throughfall
    type( field_type ) :: grid_throughfall

    type(mesh_type), pointer :: mesh => null()
    integer( kind=i_def ) :: ncells
    integer( tik )        :: id

    if ( LPROF ) call start_timing( id, 'jules.extra' )

    ! Unpack precipitation fields
    call microphysics_fields%get_field('ls_rain', ls_rain)
    call microphysics_fields%get_field('ls_snow', ls_snow)
    call microphysics_fields%get_field('ls_graup', ls_graup)
    call convection_fields%get_field('conv_rain', conv_rain)
    call convection_fields%get_field('conv_snow', conv_snow)
    call microphysics_fields%get_field('lsca_2d', lsca_2d)
    call convection_fields%get_field('cca_2d', cca_2d)

    ! Surface fields
    call surface_fields%get_field('tile_fraction', tile_fraction)
    call surface_fields%get_field('leaf_area_index', leaf_area_index)
    call surface_fields%get_field('canopy_height', canopy_height)
    call surface_fields%get_field('tile_temperature', tile_temperature)
    call surface_fields%get_field('net_prim_prod', net_prim_prod)
    call surface_fields%get_field('canopy_water', canopy_water)
    call surface_fields%get_field('snowice_melt', snowice_melt)
    call surface_fields%get_field('snowice_sublimation', snowice_sublimation)
    call surface_fields%get_field('urbztm', urbztm)

    ! Sea ice fields
    call surface_fields%get_field('sea_ice_thickness', sea_ice_thickness)
    call surface_fields%get_field('sea_ice_temperature', sea_ice_temperature)
    call surface_fields%get_field('sea_ice_conductivity', sea_ice_conductivity)
    call surface_fields%get_field('sea_ice_pensolar', sea_ice_pensolar)
    call surface_fields%get_field('melt_pond_fraction', melt_pond_fraction)
    call surface_fields%get_field('melt_pond_depth', melt_pond_depth)

    ! Soil fields
    call soil_fields%get_field('soil_moist_wilt', soil_moist_wilt)
    call soil_fields%get_field('soil_moist_crit', soil_moist_crit)
    call soil_fields%get_field('soil_moist_sat', soil_moist_sat)
    call soil_fields%get_field('soil_cond_sat', soil_cond_sat)
    call soil_fields%get_field('soil_thermal_cap', soil_thermal_cap)
    call soil_fields%get_field('soil_thermal_cond', soil_thermal_cond)
    call soil_fields%get_field('soil_suction_sat', soil_suction_sat)
    call soil_fields%get_field('clapp_horn_b', clapp_horn_b)
    call soil_fields%get_field('soil_roughness', soil_roughness)
    call soil_fields%get_field('mean_topog_index', mean_topog_index)
    call soil_fields%get_field('a_sat_frac', a_sat_frac)
    call soil_fields%get_field('c_sat_frac', c_sat_frac)
    call soil_fields%get_field('a_wet_frac', a_wet_frac)
    call soil_fields%get_field('c_wet_frac', c_wet_frac)
    call soil_fields%get_field('thermal_cond_wet_soil', thermal_cond_wet_soil)
    call soil_fields%get_field('soil_temperature', soil_temperature)
    call soil_fields%get_field('soil_moisture', soil_moisture)
    call soil_fields%get_field('unfrozen_soil_moisture', unfrozen_soil_moisture)
    call soil_fields%get_field('frozen_soil_moisture', frozen_soil_moisture)
    call soil_fields%get_field('soil_sat_frac', soil_sat_frac)
    call soil_fields%get_field('water_table', water_table)
    call soil_fields%get_field('wetness_under_soil', wetness_under_soil)
    call soil_fields%get_field('surface_runoff', surface_runoff)
    call soil_fields%get_field('sub_surface_runoff', sub_surface_runoff)

    ! Snow fields
    call snow_fields%get_field('tile_snow_mass', tile_snow_mass)
    call snow_fields%get_field('tile_snow_rgrain', tile_snow_rgrain)
    call snow_fields%get_field('n_snow_layers', n_snow_layers)
    call snow_fields%get_field('snow_depth', snow_depth)
    call snow_fields%get_field('snow_under_canopy', snow_under_canopy)
    call snow_fields%get_field('snowpack_density', snowpack_density)
    call snow_fields%get_field('snow_layer_thickness', snow_layer_thickness)
    call snow_fields%get_field('snow_layer_ice_mass', snow_layer_ice_mass)
    call snow_fields%get_field('snow_layer_liq_mass', snow_layer_liq_mass)
    call snow_fields%get_field('snow_layer_temp', snow_layer_temp)
    call snow_fields%get_field('snow_layer_rgrain', snow_layer_rgrain)
    call snow_fields%get_field('snow_unload_rate', snow_unload_rate)

    ! Initialise the snow diagnostics
    call initialise_diags_for_jules_snow(soil_moist_sat,                       &
                                         grid_snow_mass, grid_snowmelt)

    ! Initialise the soil diagnostics
    call initialise_diags_for_jules_soil(soil_moist_sat,                       &
                                         tile_fraction,                        &
                                         soil_moisture_content,                &
                                         grid_canopy_water,                    &
                                         throughfall,                          &
                                         grid_throughfall)

    mesh => ls_rain%get_mesh()
    ncells = mesh%get_last_edge_cell()
    call um_sizes_init(ncells)

    call invoke(jules_extra_kernel_type( ls_rain, conv_rain, ls_snow,          &
                           conv_snow, ls_graup, lsca_2d, cca_2d,               &
                           tile_fraction, leaf_area_index,                     &
                           canopy_height, snow_unload_rate,                    &
                           soil_moist_wilt, soil_moist_crit,                   &
                           soil_moist_sat, soil_cond_sat, soil_thermal_cap,    &
                           soil_thermal_cond, soil_suction_sat, clapp_horn_b,  &
                           soil_roughness,                                     &
                           mean_topog_index, a_sat_frac, c_sat_frac,           &
                           a_wet_frac, c_wet_frac, tile_temperature,           &
                           net_prim_prod, snowice_sublimation, surf_heat_flux, &
                           canopy_evap, water_extraction,                      &
                           thermal_cond_wet_soil, urbztm,                      &
                           soil_temperature, soil_moisture,                    &
                           unfrozen_soil_moisture, frozen_soil_moisture,       &
                           canopy_water, tile_snow_mass, tile_snow_rgrain,     &
                           n_snow_layers, snow_depth, snow_under_canopy,       &
                           snowpack_density, snow_layer_thickness,             &
                           snow_layer_ice_mass, snow_layer_liq_mass,           &
                           snow_layer_temp, snow_layer_rgrain, snowice_melt,   &
                           soil_sat_frac, water_table, wetness_under_soil,     &
                           surface_runoff, sub_surface_runoff,                 &
                           soil_moisture_content, grid_snow_mass,              &
                           throughfall) )

    if ( lake_water_conservation ) then
      call lake_water_correction(lake_evap, soil_moisture,                     &
                                 unfrozen_soil_moisture, soil_moist_sat,       &
                                 soil_moist_wilt, tile_fraction, dt)
    end if

    call um_sizes_init(1_i_def)

    if ( LPROF ) call stop_timing( id, 'jules.extra' )

    if (use_xios_io .and. write_diag) then

      ! Output the jules snow diagnostics
      call output_diags_for_jules_snow(tile_fraction, tile_snow_mass,          &
                                     snowice_melt,                             &
                                     snow_depth, tile_snow_rgrain,             &
                                     snowpack_density, snow_layer_temp,        &
                                     snow_layer_thickness, snow_layer_ice_mass,&
                                     snow_layer_liq_mass, snow_layer_rgrain,   &
                                     grid_snow_mass, grid_snowmelt)

      ! Output the jules soil diagnostics
      call output_diags_for_jules_soil(tile_fraction, soil_moisture_content,   &
                                     canopy_water, soil_moisture,              &
                                     soil_temperature, unfrozen_soil_moisture, &
                                     frozen_soil_moisture, throughfall,        &
                                     surface_runoff, sub_surface_runoff,       &
                                     water_table, soil_moist_wilt,             &
                                     soil_moist_crit, soil_moist_sat,          &
                                     grid_canopy_water,grid_throughfall)

      ! Output sea ice diagnostics
      call output_diags_for_jules_seaice(tile_fraction, sea_ice_thickness,     &
                                    sea_ice_temperature, sea_ice_conductivity, &
                                    sea_ice_pensolar, melt_pond_fraction,      &
                                    melt_pond_depth)

    end if

  end subroutine jules_extra_alg

end module jules_extra_alg_mod
