{# ########################################################################### #}
{# (c) Crown copyright 2024 Met Office. All rights reserved. #}
{# The file LICENCE, distributed with this code, contains details of the terms #}
{# under which the code may be used. #}
{# ########################################################################### #}
{% do LOG.debug("Entered templates/runtime/generate_runtime_technical-tests.cylc") %}

{# Generate runtime sections for integration/unit tests build and run parts #}

{% set src_path = tasks_to_run[task]["application_dir"] %}
{% if "unit_test" in task %}
    {% set mode = "unit-tests" %}
{% else %}
    {% set mode = "integration-tests" %}
{% endif %}

{% if task.startswith("build") %}
{# generate the runtime section for unit/integration build tasks #}

{# Set the family inheritance for this task #}
    {% set inherit = namespace(str="") %}
    {% set inherit.str = "BUILD_"~task_ns.platform|upper %}
    {% for family in task_values["build_families"] %}
        {% set inherit.str = inherit.str~","~family|upper %}
    {% endfor %}

    {# Build Script #}
    {% set build_script_str = "make -C $SOURCE_DIRECTORY "~
                        "-j 6 "~mode~"/build APPS_ROOT_DIR=${APPS_ROOT_DIR} "~
                        "CORE_ROOT_DIR=${CORE_ROOT_DIR}" %}

    [[{{task}}]]
        inherit={{inherit.str|upper}}
        script={{build_script_str}}

        [[[environment]]]
            SOURCE_DIRECTORY = $SOURCE_ROOT/{{src_path}}
            APPS_ROOT_DIR = $SOURCE_ROOT/apps
            CORE_ROOT_DIR = $SOURCE_ROOT/core
            WORKING_DIR = {{working_dir}}/{{mode}}
            RDEF_PRECISION = {{task_values["precision"]["rdef"]}}


{% else %}
{# generate the runtime section for unit/integration run tasks #}

    {# Define a cylc family for this task #}
    [[{{task_family|upper}}]]
        inherit={{task_ns.application|upper}}_{{task_ns.platform|upper}}

    {# Set the family inheritance for this task #}
    {% set inherit = namespace(str="") %}
    {% set inherit.str = task_family|upper %}
    {% for family in task_values["techtests_families"] %}
        {% set inherit.str = inherit.str~","~family|upper %}
    {% endfor %}

    {# Run script #}
    {% set run_script_str = "make -C $SOURCE_DIRECTORY -j 6 "~
                        mode~"/rerun APPS_ROOT_DIR=${APPS_ROOT_DIR} "~
                        "CORE_ROOT_DIR=${CORE_ROOT_DIR}" %}

    [[{{task}}]]
        inherit={{inherit.str|upper}}
        script={{run_script_str}}

        [[[environment]]]
            SOURCE_DIRECTORY = $SOURCE_ROOT/{{src_path}}
            APPS_ROOT_DIR = $SOURCE_ROOT/apps
            CORE_ROOT_DIR = $SOURCE_ROOT/core
            WORKING_DIR = {{working_dir}}/{{mode}}

{% endif %}

{% do LOG.debug("Finished in templates/runtime/generate_runtime_technical-tests.cylc") %}